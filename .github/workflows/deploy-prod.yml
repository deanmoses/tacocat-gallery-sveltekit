name: Deploy to Production

on:
    workflow_dispatch:

concurrency:
    group: deploy-production
    cancel-in-progress: false # Don't cancel in-progress deploys

env:
    HUSKY: 0 # Skip git hooks in CI - we run checks directly

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint

            - name: Type check
              run: npm run check

            - name: Unit tests
              run: npm run test:unit

            - name: Build
              run: npm run build

            # Upload build artifacts for deploy job
            - name: Upload build artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build
                  path: build/
                  retention-days: 1

    deploy:
        needs: build
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Download build artifacts
              uses: actions/download-artifact@v4
              with:
                  name: build
                  path: build/

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v4
              with:
                  aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                  aws-region: us-east-1

            - name: Deploy to production
              run: ./deploy_prod.sh

    smoke-test:
        needs: deploy
        runs-on: ubuntu-latest

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Cache Playwright browsers
              uses: actions/cache@v4
              with:
                  path: ~/.cache/ms-playwright
                  key: playwright-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

            - name: Install Playwright browsers
              run: npx playwright install chromium

            - name: Run smoke test against production
              run: npm run test:e2e:prod

    create-release:
        needs: smoke-test
        runs-on: ubuntu-latest
        permissions:
            contents: write # Required for pushing tags and creating releases

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history needed to find latest tag

            - name: Create release tag
              id: tag
              run: |
                  # Get current year
                  year=$(date +%Y)

                  # Find the latest tag for this year
                  latest_tag=$(git tag -l "${year}v*" | sort -V | tail -n1)

                  if [ -z "$latest_tag" ]; then
                      # No tags this year, start at v1
                      new_tag="${year}v1"
                  else
                      # Extract version number and increment
                      version_num=${latest_tag#${year}v}
                      new_version=$((version_num + 1))
                      new_tag="${year}v${new_version}"
                  fi

                  echo "Creating tag: $new_tag"
                  echo "tag=$new_tag" >> $GITHUB_OUTPUT

                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git tag -a "$new_tag" -m "Production release $new_tag"
                  git push origin "$new_tag"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ steps.tag.outputs.tag }}
                  name: ${{ steps.tag.outputs.tag }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
