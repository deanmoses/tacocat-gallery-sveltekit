<!-- AUTOGENERATED FILE, DO NOT EDIT DIRECTLY -->
<!-- To regenerate, run `npm run agent-docs` -->
<!-- Source content: docs/AGENTS.src.md -->

# AGENTS.md

This file provides guidance to AI programming agents when working with code in this repository.

## Build & Development Commands

```bash
npm run dev          # Start Vite dev server
npm run build        # Production build
npm run build-debug  # Build with sourcemaps, no minification
npm run test:unit    # Run Vitest unit tests
npm run test:e2e     # Run Playwright E2E tests
npm run test         # Run all tests (unit + E2E)
npm run check        # Type checking (svelte-check + TypeScript)
npm run lint         # ESLint + Prettier check
npm run format       # Auto-format with Prettier
npm run quality      # Format, lint, and type check
npm run precommit    # Quality checks + unit tests (for pre-commit/pre-PR)
npm run agent-docs   # Regenerate CLAUDE.md and AGENTS.md
npm run build && npm run deploy-staging  # Build and deploy to staging
```

Do NOT deploy to production. NEVER deploy to production. There's a GitHub Action for that, that runs integration tests and creates a release tag and a release.

Merging to `main` automatically deploys to staging via GitHub Actions.

## Node.js

Requires Node.js >=24.0.0.

## Tech Stack

- **SvelteKit 2** with Svelte 5 - Static adapter (SPA mode, SSR disabled). All code runs in the browser; there is no server-side rendering.
- **Vite 6** - Dev and preview servers proxy `/api/*` to backend
- **TypeScript** - Strict mode enabled
- **Immer** - Immutable state updates via `produce()`
- **Quill** - Rich text editing for descriptions
- **Playwright** - E2E testing

## Architecture

### Routing

- `/` - Root album (all photos)
- `/[year]` - Year album
- `/[year]/[day]` - Day album (MM-DD format)
- `/[year]/[day]/[image]` - Image detail view
- `/search/[terms]` - Search results
- `/login` - Auth redirect handler

### State Management Pattern

Stores follow strict separation between **state transition methods** and **service methods**:

1. **State Transition Methods** (public)
    - Synchronous, return `void`
    - Only way to update state
    - May fire-and-forget async work
    - Use Svelte 5's `$state` and `$derived`

2. **Service Methods** (private)
    - Async, do actual work (fetch, save)
    - Call state transition methods when complete
    - Never mutate state directly

See `docs/Svelte.md` for detailed Svelte 5 patterns and TypeScript conventions.

### Key Stores

- `SessionStore` - Authentication state
- `AlbumState` - Global album/image state
- `AlbumLoadMachine` - Album fetching state machine
- Admin state machines: `UploadMachine`, `AlbumCreateMachine`, `AlbumDeleteMachine`, `AlbumRenameMachine`, `ImageDeleteMachine`, `ImageRenameMachine`, `CropMachine`, `DraftMachine`

### Data Models

Located in `/src/lib/models/impl/`. Pure data structures (no fetching/persistence):

- Album types: ROOT, YEAR, DAY
- `AlbumCreator` factory converts server JSON to model instances
- Strict path validation via regex in `galleryPathUtils.ts`

### Gallery Path System

- Album paths: `/`, `/2001/`, `/2001/12-31/`
- Image paths: `/2001/12-31/image.jpg` (only in day albums)
- Path validation and sanitization enforced throughout

## API Integration

- Localhost: Vite proxies `/api/*` to staging backend (both dev and preview servers)
- Staging: `https://api.staging-pix.tacocat.com/`
- Production: `https://api.pix.tacocat.com/`

Key endpoints:

- `GET /album[path]` - Fetch album
- `PUT/PATCH/DELETE /album[path]` or `/image[path]` - CRUD
- `POST /presigned[path]` - S3 upload URLs

Album data cached in IndexedDB with network fallback.

## Authentication

- Cognito-hosted login via redirect
- Session cookies with `credentials: 'include'`
- `FAKE_ADMIN_ON_DEV = true` in `SessionStore` simulates admin locally
- Auth endpoints at `https://auth.pix.tacocat.com/`

## Code Conventions

- 4-space indentation, 120 char lines, single quotes
- `.svelte.ts` files for Svelte stores/state machines
- PascalCase components, camelCase utilities

## Tools & CI

- **gh CLI**: Use the `gh` CLI tool for GitHub operations.

- **Pre-commit hooks**: Husky runs gitleaks (secret scanning), lint-staged, type checking, and unit tests on commit. To bypass when needed: `git commit --no-verify`
- **Gitleaks**: Secret scanner runs on pre-commit. Install with `brew install gitleaks`. The hook warns but continues if gitleaks is not installed.

## Git Amend

`git commit --amend` only amends HEAD (the most recent commit). To amend an older commit, you must use interactive rebase:

```bash
git rebase -i <commit>^   # Interactive rebase starting from parent of target commit
# Change "pick" to "edit" for the commit you want to amend
# Make your changes, then:
git add <files>
git commit --amend
git rebase --continue
```

## Branch Protection

The `main` branch is protected:

- Requires PR before merging (no direct pushes)
- Requires status checks to pass
- Does NOT require reviews
- Does NOT require branches to be up to date

Repo settings:

- Auto-delete head branches after merge

## Branch, Commit and PR Conventions

Use these types for branch names, commit messages, and PR titles:

- `feat`: User-facing features or behavior changes (must change production code)
- `fix`: Bug fixes (must change production code)
- `docs`: Documentation only
- `style`: Code style/formatting (no logic changes)
- `refactor`: Code restructuring without behavior change
- `test`: Adding or updating tests
- `chore`: CI/CD, tooling, dependency bumps, configs (no production code)

### Branch Naming

Use `type/short-description`:

```text
feat/infinite-scroll
fix/album-path-validation
chore/pre-commit-hooks
```

### Commit Messages

Use [Conventional Commits](https://www.conventionalcommits.org/):

```text
<type>(<scope>): <description>

[optional body]
```

- **Scopes:** Optional. Use when it adds clarity (e.g., `ui`, `api`, `state`, `auth`).
- **Breaking changes:** Use `!` suffix: `feat!: remove deprecated API`

**Examples:**

```text
feat(search): add infinite scroll to results
fix(album): correct image path validation
chore: add husky pre-commit hooks
docs: update API documentation
```

### Pull Requests

**PR titles:** Use conventional commit format, same as commit messages.

**PR descriptions:**

```markdown
## Summary

One sentence describing the overall change.

- Optional supporting details
- If needed

## Test plan

- [ ] How to verify it works
```

### PR Labels

Use labels on pull requests. Apply all labels that fit. Only use these labels:

- `enhancement` - User-facing features or improvements (must change production code behavior)
- `refactor` - Production code changes that don't alter behavior
- `bug` - Fixes broken production code functionality
- `test` - Changes to tests
- `documentation` - Documentation changes

**No label needed** for dependency bumps, CI/CD, tooling, or infrastructure changes - these go in "Other Changes" in release notes.

## AI Assistant Configuration

This repository uses `docs/AGENTS.src.md` as the single source of truth for AI assistant instructions. Two files are auto-generated from it:

- `CLAUDE.md` - Instructions for Claude Code
- `AGENTS.md` - Generic instructions for other AI assistants

**To update AI assistant instructions:**

1. Edit `docs/AGENTS.src.md` (never edit CLAUDE.md or AGENTS.md directly)
2. Run `npm run agent-docs` to regenerate, or just commit and the pre-commit hook will regenerate automatically

**Conditional content markers:**

- `START_CLAUDE` / `END_CLAUDE` - Content appears only in CLAUDE.md
- `START_AGENTS` / `END_AGENTS` - Content appears only in AGENTS.md
- `START_IGNORE` / `END_IGNORE` - Content stripped from both (for source file metadata)
